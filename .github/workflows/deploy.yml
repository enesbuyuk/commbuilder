name: Deploy Docker to Server

on:
  push:
    branches:
      - main

jobs:
  deploy-iucs:
    runs-on: ubuntu-latest
    name: Deploy to iucs.net

    steps:
      - name: Deploy to server via SSH [iucs.net]
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            export DOCKER_BUILDKIT=1
            set -e
            cd ${{ secrets.SERVER_PROJECT_PATH }}

            git config --global --add safe.directory ${{ secrets.SERVER_PROJECT_PATH }}

            git fetch origin main
            git reset --hard origin/main

            docker compose build mongodb traefik commbuilder-backend            
            docker compose up -d mongodb traefik commbuilder-backend

            docker image prune -f
            docker compose ps

  deploy-awscc:
    runs-on: ubuntu-latest
    name: Deploy to awscc.iucs.net

    steps:
      - name: Deploy to server via SSH [awscc.iucs.net]
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.AWSCC_SERVER_IP }}
          username: ${{ secrets.AWSCC_SERVER_USER }}
          key: ${{ secrets.AWSCC_SERVER_SSH_KEY }}
          script: |
            export DOCKER_BUILDKIT=1
            set -e
            cd ${{ secrets.AWSCC_SERVER_PROJECT_PATH }}

            git config --global --add safe.directory ${{ secrets.AWSCC_SERVER_PROJECT_PATH }}

            git fetch origin main
            git reset --hard origin/main

            sed "s/commbuilder-backend/commbuilder-backend-awscc/g" docker-compose.yml > docker-compose.override.yml
            
            docker compose build -f docker-compose.override.yml commbuilder-backend-awscc
            docker compose -f docker-compose.override.yml up -d commbuilder-backend-awscc


            docker image prune -f
            docker compose ps
